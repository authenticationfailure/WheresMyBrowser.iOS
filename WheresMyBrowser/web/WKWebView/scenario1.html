<!DOCTYPE html>
<html>
    <head>
        <script src="http://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <style>
            body {font-family: Arial,"Helvetica Neue",Helvetica,sans-serif;}
            h1, h2, h3  {color: darkblue}
        </style>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <h1>WKWebView Scenario 1</h1>
        <h2>Resource loaded from file:// Url</h2>
        <h3>Description</h3>
        <p>In this scenario the page is loaded from a file:// URL;
        however some content is loaded insecurely from the Internet over http.</p>
        
        <h3>Tasks</h3>
        <ol>
            <li>This scenario replicates the "UIWebView Scenario 1"; however WKWebViews behave differently. Is it still possible to exfiltrate the secret from the user's defaults plist file?</li>
            <li>Try enabling the option "Allow File Access from File". This enables an undocumented setting*, which allows to access files from a file:// URL. Can you exfiltrate the secret now?</li>
            <li>Notice that contrary to the "UIWebView Scenario 1", the Apple stock price fails to load. However the comment does load correctly. Can you explain why?</li>
        </ol>
        <p>* WKWebViews don't allow JavaScript to access the content of file:// URLs. This behaviour can be changed by setting the undocumented preference "allowFileAccessFromFileURLs" to "Yes":
            <code>
        wkWebView.configuration.preferences.setValue("Yes", forKey: "allowFileAccessFromFileURLs")
        </code>
        </p>
        <hr/>
        <h3>Page Content</h3>
        This data is fetched from two remote APIs.
        
        <p>The last comment is:</p>
        <p id="output_comment" style="background-color: #E0E0E0"></p>
        
        <p>Apple stock price is:</p>
        <p id="output_stock" style="background-color: #E0E0E0"></p>
        
        <script>
            var xhttp_comment = new XMLHttpRequest();
            
            xhttp_comment.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        jsonObject=JSON.parse(this.responseText);
                        document.getElementById("output_comment").innerHTML=jsonObject[4]['body'];
                    } else {
                        document.getElementById("output_comment").innerHTML="<div style='color:red'>Error: could not load remote data</div>";
                    }
                }
            }
        // The comments API implements a CORS policy
        // and returns the header Access-Control-Allow-Origin: file://
        xhttp_comment.open("GET", "http://jsonplaceholder.typicode.com/posts/1/comments/", true);
        xhttp_comment.send();
            </script>
        
        <script>
            var xhttp_no_cors = new XMLHttpRequest();
            
            xhttp_no_cors.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        jsonObject=JSON.parse(this.responseText.replace(/\/\/\ \[/,"["));
                        console.log(jsonObject[0].f_reuters_url);
                        document.getElementById("output_stock").innerHTML=jsonObject[0].l+" USD";
                    } else {
                        document.getElementById("output_stock").innerHTML= "<div style='color:red'>Error: could not load remote data. This is the expected behaviour for WKWebViews.</div>";
                    }
                }
            }
                         
            // The finance API does not set a CORS policy
            // This fails to load in a WKWebView
            xhttp_no_cors.open("GET", "http://finance.google.com/finance?q=NASDAQ:AAPL&output=json", true);
            xhttp_no_cors.send();
        </script>
        
        <hr/>
        
        <h3>Exploitation Helper</h3>
        
        <form id="payload_form" onsubmit="event.preventDefault(); window.eval(document.getElementById('payload').value)" action="#">
            <label for="payload">You can simulate the attack by writing a payload in the text area below and pressing 'Evaluate Payload':</label><br>
            <textarea id="payload" rows=6 style="width:100%">// Replace last comment and stock price
                document.getElementById("output_comment").innerHTML="My new comment";
                document.getElementById("output_stock").innerHTML="XXXXX USD";
            </textarea>
            <button id="run_payload" type="submit">Evaluate Payload</button>
        </form>
        
    </body>
</html>

